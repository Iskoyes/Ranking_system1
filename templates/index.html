<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Swimming Results</title>
  <style>
    :root{
      --bg: #0b1526;
      --card: #0f1c33;
      --ink: #e8eefc;
      --muted: #9bb0d3;
      --accent: #3aa3ff;
      --radius: 18px;
      --gap: 14px;
    }
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color: var(--ink);
      background: radial-gradient(1000px 600px at 20% -10%, #123 0%, #0b1526 60%) fixed, var(--bg);
      display:grid; place-items:center; padding:32px 16px;
    }
    .wrap{width:min(100%, 800px)}
    header{display:flex; align-items:center; justify-content:space-between; margin-bottom:18px;}
    .brand{display:flex; align-items:baseline; gap:10px}
    .brand h1{font-size:clamp(22px,3.6vw,34px); margin:0; font-weight:750}
    .brand small{color:var(--muted); font-weight:500}
    .card{
      background: linear-gradient(180deg, #0f1c33 0%, #0d182b 100%);
      border:1px solid #1c2b46; border-radius:var(--radius);
      box-shadow:0 8px 30px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.03);
      overflow:hidden;
    }
    .card-head{padding:18px 22px; border-bottom:1px solid #1a2a45; display:flex; justify-content:space-between; align-items:center}
    .card-head h2{margin:0; font-size:16px; color:var(--muted); font-weight:600}
    form{padding:22px; display:grid; gap:var(--gap)}
    .grid{display:grid; grid-template-columns:1fr; gap:var(--gap)}
    .field{display:grid; gap:6px}
    .field label{display:block; font-size:13px; color:var(--muted); margin:0;}
    input[type="text"], input[type="number"], input[type="date"], select, input[type="password"]{
      appearance:none; width:100%; padding:12px;
      border-radius:12px; border:1px solid #203357; background:#0b1a30; color:var(--ink);
      outline:none; transition:border-color .15s, box-shadow .15s, background .15s;
    }
    input::placeholder{color:#7f95b9}
    input:focus, select:focus{border-color:var(--accent); box-shadow:0 0 0 3px rgba(58,163,255,.15); background:#0e213e}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .radio{display:flex; gap:8px; align-items:center; padding:10px 12px; border:1px solid #203357; background:#0b1a30; border-radius:12px; cursor:pointer}
    .radio input{accent-color:var(--accent)}
    .hint{font-size:12px; color:var(--muted)}
    .actions{margin-top:6px; display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    .btn{appearance:none; border:0; cursor:pointer; padding:12px 16px; border-radius:12px; font-weight:600}
    .btn-primary{background: linear-gradient(180deg, var(--accent) 0%, #1477d9 100%); color:#061425; box-shadow:0 8px 18px rgba(58,163,255,.35)}
    .btn-outline{background:transparent; color:var(--ink); border:1px solid #26456f}
    .flash{padding:10px 12px; border-radius:12px; font-size:13px; border:1px solid transparent; margin:8px 22px}
    .flash.ok{color:#07261f; background:#c8f5ec; border-color:#7fe7d6;}
    .flash.err{color:#2a0b0f; background:#ffd9de; border-color:#ff97a3;}
    .flash-wrap{position:fixed; top:16px; right:16px; display:flex; flex-direction:column; gap:8px; z-index:9999}
    /* Table styling */
    #entries{width:100%; border-collapse:collapse; font-size:15px}
    #entries th, #entries td{border:1px solid #26456f; padding:10px 12px}
    #entries thead tr{background:#0e213e}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <h1>Swimming Results</h1>
        <small>Performance Entry</small>
      </div>
    </header>

    <!-- Flash messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, msg in messages %}
          <div class="flash {{ category }}">{{ msg }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    {% if not session.logged_in %}
      <!-- Login Form -->
      <form action="{{ url_for('login') }}" method="post">
        <div class="grid">
          <div class="field">
            <label for="username">Username</label>
            <input id="username" name="username" type="text" placeholder="Username" required />
          </div>
          <div class="field">
            <label for="password">Password</label>
            <input id="password" name="password" type="password" placeholder="Password" required />
          </div>
        </div>
        <div class="actions">
          <button class="btn btn-primary" type="submit">Login</button>
        </div>
      </form>
    {% else %}
      <!-- Swimmer Submission Form -->
      <form id="swimmer-form" action="{{ url_for('add_data') }}" method="post">
        <div class="grid">
          <!-- Year of Birth -->
          <div class="field">
            <label for="year_of_birth">Дата рождения</label>
            <input id="year_of_birth" name="year_of_birth" type="number" min="1900" max="2025" placeholder="Год рождения" required />
          </div>
          <!-- Full Name -->
          <div class="field">
            <label for="full_name">ФИО</label>
            <input id="full_name" name="full_name" type="text" placeholder="ФИО" required />
          </div>
          <!-- Gender -->
          <div class="field">
            <label>Пол</label>
            <div class="row" role="group" aria-label="Gender">
              <label class="radio"><input type="radio" name="gender" value="M" checked /> Мужчина</label>
              <label class="radio"><input type="radio" name="gender" value="F" /> Женщина</label>
            </div>
          </div>
          <div class="field">
            <label for="name_of_competition">Название соревнований</label>
            <select id="name_of_competition" name="name_of_competition" required>
              <option value="ЧРК по плаванию Костанай">ЧРК Костанай</option>
              <option value="РТ Жемчужина бурабая" selected>РТ Жемчужина бурабая</option>
              <option value="РТ по плаванию Веселый дельфин" selected>РТ Веселый дельфин</option>
              <option value="РТ по плаванию SwimFeelsCup"> РТ SwimFeelsCup</option>
              <option value="ЧРК Астана" selected>ЧРК Астана</option>
              <option value="РТ Семей">РТ Семей</option>
              <option value="ЛЧРК" selected>ЛЧРК</option>
              <option value="ЧРК Шымкент" selected>ЛЧРК</option>
              <option value="РТ Жібек жолы" selected>РТ Жибек жолы</option>
              <option value="МЧРК" selected>МЧРК</option>
              <option value="ЗЧРК" selected>ЗЧРК</option>
              <option value="РТ Ақтөбе үміттері"selected>РТ Ақтөбе үміттері</option>
              <option value="РТ Алтай жұлдызы"selected>РТ Алтай жұлдызы</option>
              <option value="Кубок РК"selected>Кубок РК</option>
              <option value="РТ Astana Open"selected>РТ Astana Open</option>
            </select>
          </div>
          <!-- Date of Competition -->
          <div class="field">
            <label for="date_of_competition">Дата соревнований</label>
            <input id="date_of_competition" name="date_of_competition" type="date" required />
          </div>
          <!-- Pool Length -->
          <div class="field">
            <label for="pool_length">Длина бассейна</label>
            <select id="pool_length" name="pool_length" required>
              <option value="25">25 m</option>
              <option value="50" selected>50 m</option>
            </select>
          </div>
          <div class="field">
            <label for="place_t">Занятое место</label>
            <input id="place_taken" name="place_taken" type="number" placeholder="Занятое место" required />
          </div>
          <!-- Event -->
          <div class="field">
            <label for="event">Дистанция</label>
            <select id="event" name="event" required>
              <option value="" disabled selected>Выберите дистанцию</option>
              <optgroup label="Backstroke">
                <option>50M Backstroke</option>
                <option>100M Backstroke</option>
                <option>200M Backstroke</option>
              </optgroup>
              <optgroup label="Freestyle">
                <option>50M Freestyle</option>
                <option>100M Freestyle</option>
                <option>200M Freestyle</option>
                <option>400M Freestyle</option>
              </optgroup>
              <optgroup label="Breaststroke">
                <option>50M Breaststroke</option>
                <option>100M Breaststroke</option>
                <option>200M Breaststroke</option>
              </optgroup>
              <optgroup label="Butterfly">
                <option>50M Butterfly</option>
                <option>100M Butterfly</option>
                <option>200M Butterfly</option>
              </optgroup>
              <optgroup label="IM">
                <option>200M Medley</option>
                <option>400M Medley</option>
              </optgroup>
            </select>
          </div>
          <!-- Result -->
          <div class="field">
            <label for="result">Результат (секунды)</label>
            <input id="result" name="result" type="number" step="0.01" placeholder="64.60" required />
            <div class="hint">Пишите время в секундах (например: 64.60).</div>
          </div>
        </div>
        <div class="actions">
          <button id="btn-clear" class="btn btn-outline" type="reset">Очистить</button>
          <button id="btn-submit" class="btn btn-primary" type="submit">Добавить</button>
        </div>
      </form>
      <!-- Actions row -->
      <div class="actions" style="justify-content:flex-start; padding: 0 22px 10px 22px;">
        <button id="btn-refresh" class="btn btn-outline" type="button">Обновить</button>
        <button id="btn-export" class="btn btn-primary" type="button">Вывод в виде Excel</button>
      </div>

      <!-- Recent Entries -->
      <div class="card" style="margin-top: 12px;">
        <div class="card-head">
          <h2>Посление 20 записей</h2>
        </div>
        <div style="padding: 12px 22px 18px 22px; overflow:auto;">
          <table id="entries" style="width:100%; border-collapse: collapse; font-size: 13px;">
            <thead>
              <tr style="text-align:left; color: var(--muted);">
                <th>ID</th>
                <th>Имя</th>
                <th>Дата рождения</th>
                <th>Пол</th>
                <th>Дистанция</th>
                <th>Результат (секунды)</th>
                <th>Дата</th>
                <th>Бассейн</th>
                <th>Занятое место</th>
                <th>FINA</th>
                <th>Rudolph</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <form action="{{ url_for('logout') }}" method="get" style="margin-top: 10px;">
        <button class="btn btn-outline" type="submit">Выйти</button>
      </form>
    {% endif %}

  </div>
</body>
{% if session.logged_in %}
<script>
  const flashContainer = document.createElement('div');
  flashContainer.className = 'flash-wrap';
  document.body.appendChild(flashContainer);

  function showFlash(kind, message) {
    const div = document.createElement('div');
    div.className = 'flash ' + (kind === 'ok' ? 'ok' : 'err');
    div.textContent = message;
    flashContainer.appendChild(div);
    setTimeout(() => div.remove(), 4000);
  }

  function h(value) {
    return value == null ? '' : String(value);
  }

  async function fetchEntries() {
    try {
      const res = await fetch('{{ url_for('list_swimmers') }}');
      if (!res.ok) throw new Error('Failed to load entries');
      const data = await res.json();
      renderEntries(data);
    } catch (e) {
      showFlash('err', e.message || 'Failed to load entries');
    }
  }

  function renderEntries(rows) {
    const tbody = document.querySelector('#entries tbody');
    tbody.innerHTML = '';
    rows.forEach(row => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${h(row.id)}</td>
        <td><input value="${h(row.full_name)}" style="width:140px" /></td>
        <td><input type="number" value="${h(row.year_of_birth)}" style="width:70px" /></td>
        <td>
          <select style="width:70px">
            <option value="M" ${row.gender==='M'?'selected':''}>M</option>
            <option value="F" ${row.gender==='F'?'selected':''}>F</option>
          </select>
        </td>
        <td>
          <select style="width:160px">
            <option value="50M Backstroke" ${row.event==='50M Backstroke'?'selected':''}>50M Backstroke</option>
            <option value="100M Backstroke" ${row.event==='100M Backstroke'?'selected':''}>100M Backstroke</option>
            <option value="200M Backstroke" ${row.event==='200M Backstroke'?'selected':''}>200M Backstroke</option>
            <option value="50M Freestyle" ${row.event==='50M Freestyle'?'selected':''}>50M Freestyle</option>
            <option value="100M Freestyle" ${row.event==='100M Freestyle'?'selected':''}>100M Freestyle</option>
            <option value="200M Freestyle" ${row.event==='200M Freestyle'?'selected':''}>200M Freestyle</option>
            <option value="400M Freestyle" ${row.event==='400M Freestyle'?'selected':''}>400M Freestyle</option>
            <option value="50M Breaststroke" ${row.event==='50M Breaststroke'?'selected':''}>50M Breaststroke</option>
            <option value="100M Breaststroke" ${row.event==='100M Breaststroke'?'selected':''}>100M Breaststroke</option>
            <option value="200M Breaststroke" ${row.event==='200M Breaststroke'?'selected':''}>200M Breaststroke</option>
            <option value="50M Butterfly" ${row.event==='50M Butterfly'?'selected':''}>50M Butterfly</option>
            <option value="100M Butterfly" ${row.event==='100M Butterfly'?'selected':''}>100M Butterfly</option>
            <option value="200M Butterfly" ${row.event==='200M Butterfly'?'selected':''}>200M Butterfly</option>
            <option value="200M Medley" ${row.event==='200M Medley'?'selected':''}>200M Medley</option>
            <option value="400M Medley" ${row.event==='400M Medley'?'selected':''}>400M Medley</option>
          </select>
        </td>
        <td><input type="number" step="0.01" value="${h(row.result)}" style="width:90px" /></td>
        <td><input type="date" value="${h(row.date_of_competition)}" style="width:130px" /></td>
        <td><select style="width:70px"><option value="25" ${row.pool_length==25?'selected':''}>25</option><option value="50" ${row.pool_length==50?'selected':''}>50</option></select></td>
        <td>${h(row.fina_points)}</td>
        <td>${h(row.rudolph_points)}</td>
        <td>
          <button class="btn btn-outline" data-action="save">Сохранить</button>
          <button class="btn btn-outline" data-action="delete">Удалить</button>
        </td>
      `;
      // Wire actions
      tr.querySelector('[data-action="save"]').addEventListener('click', async (e) => {
        e.preventDefault();
        const inputs = tr.querySelectorAll('input, select');
        const payload = {
          full_name: inputs[0].value,
          year_of_birth: Number(inputs[1].value),
          gender: inputs[2].value,
          event: inputs[3].value,
          result: inputs[4].value,
          date_of_competition: inputs[5].value,
          pool_length: Number(inputs[6].value)
        };
        try {
          const res = await fetch(`{{ url_for('update_swimmer', swimmer_id=0) }}`.replace('0', row.id), {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const j = await res.json().catch(()=>({}));
          if (!res.ok) throw new Error(j.error || 'Update failed');
          showFlash('ok', 'Saved');
          fetchEntries();
        } catch (err) {
          showFlash('err', err.message || 'Update failed');
        }
      });
      tr.querySelector('[data-action="delete"]').addEventListener('click', async (e) => {
        e.preventDefault();
        if (!confirm('Delete this entry?')) return;
        try {
          const res = await fetch(`{{ url_for('delete_swimmer', swimmer_id=0) }}`.replace('0', row.id), { method: 'DELETE' });
          const j = await res.json().catch(()=>({}));
          if (!res.ok) throw new Error(j.error || 'Delete failed');
          showFlash('ok', 'Deleted');
          tr.remove();
        } catch (err) {
          showFlash('err', err.message || 'Delete failed');
        }
      });
      tbody.appendChild(tr);
    });
  }

  // Form submit via AJAX
  document.getElementById('swimmer-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.currentTarget;
    const fd = new FormData(form);
    try {
      const res = await fetch(form.action, { method: 'POST', body: fd });
      const j = await res.json();
      if (!res.ok) throw new Error(j.error || 'Submission failed');
      showFlash('ok', j.message || 'Saved');
      fetchEntries();
    } catch (err) {
      showFlash('err', err.message || 'Submission failed');
    }
  });

  // Clear button clears and removes flashes
  document.getElementById('btn-clear').addEventListener('click', () => {
    flashContainer.innerHTML = '';
  });

  // Refresh list
  document.getElementById('btn-refresh').addEventListener('click', fetchEntries);

  // Export button
  document.getElementById('btn-export').addEventListener('click', () => {
    window.location.href = '{{ url_for('export_excel') }}';
  });

  // Initial load
  fetchEntries();
</script>
{% endif %}
</html>
